<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Lookup - Smart HIS</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@700;800&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            overflow: hidden;
        }

        h1,
        h2,
        h3,
        .brand-font {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .sidebar {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
        }

        .sidebar-tooltip {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: #1e293b;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
            white-space: nowrap;
            margin-left: 12px;
            z-index: 60;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .sidebar-item:hover .sidebar-tooltip {
            opacity: 1;
            transform: translateY(-50%) translateX(4px);
        }

        .sidebar-active {
            background-color: #4f46e5 !important;
            color: white !important;
            box-shadow: 0 4px 12px -2px rgba(79, 70, 229, 0.4);
        }

        .search-container {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .patient-card {
            transition: all 0.2s ease;
        }

        .patient-card:hover {
            transform: translateY(-2px);
            border-color: #6366f1;
            background-color: #f8faff;
        }

        .tab-active {
            color: #4f46e5;
            border-bottom: 2px solid #4f46e5;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>

<body class="min-h-screen text-slate-900">

    <!-- Top Navigation Bar -->
    <header
        class="bg-white border-b border-slate-200 h-16 fixed w-full top-0 z-40 flex items-center justify-between px-6 shadow-sm">
        <div class="flex items-center space-x-3">
            <div class="bg-indigo-600 text-white p-1.5 rounded-lg">
                <i data-feather="activity" class="w-5 h-5"></i>
            </div>
            <h1 class="text-lg font-bold text-slate-800 tracking-tight">Smart HIS</h1>
        </div>

        <div class="flex items-center space-x-6">
            <div class="text-right hidden sm:block">
                <p class="text-[10px] font-black text-indigo-600 uppercase tracking-widest" id="live-date">Monday, 23
                    Feb
                </p>
                <p class="text-sm font-bold text-slate-700 leading-none" id="live-time">09:30 AM</p>
            </div>

            <div class="h-8 w-px bg-slate-200"></div>

            <div class="flex items-center gap-3">
                <div class="text-right">
                    <p class="text-sm font-bold text-slate-800" id="doc-name">Dr. Loading...</p>
                    <p class="text-[9px] text-emerald-600 font-bold uppercase tracking-wider">Active Portfolio</p>
                </div>
                <div
                    class="w-9 h-9 rounded-xl bg-indigo-100 border-2 border-white flex items-center justify-center shadow-sm overflow-hidden">
                    <img id="doc-avatar" src="https://ui-avatars.com/api/?name=Doctor&background=6366f1&color=fff"
                        class="w-full h-full object-cover">
                </div>
            </div>
        </div>
    </header>

    <div class="flex h-screen pt-16">
        <!-- Sleek Sidebar -->
        <aside class="sidebar bg-slate-900 text-white w-16 flex flex-col items-center py-6 flex-shrink-0 z-50">
            <nav class="flex-1 flex flex-col space-y-6 w-full px-2">
                <a href="DOCTOR_PORTAL.html"
                    class="sidebar-item relative flex items-center justify-center w-10 h-10 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800 transition-all">
                    <i data-feather="grid" class="w-5 h-5"></i>
                    <span class="sidebar-tooltip">Dashboard</span>
                </a>

                <a href="APPOINTMENTS.html"
                    class="sidebar-item relative flex items-center justify-center w-10 h-10 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800 transition-all">
                    <i data-feather="users" class="w-5 h-5"></i>
                    <span class="sidebar-tooltip">Patient Queue</span>
                </a>

                <a href="PATIENT_LOOKUP.html"
                    class="sidebar-item sidebar-active relative flex items-center justify-center w-10 h-10 rounded-xl transition-all">
                    <i data-feather="search" class="w-5 h-5"></i>
                    <span class="sidebar-tooltip">Patient Finder</span>
                </a>

                <a href="DDI_CHECKER.html"
                    class="sidebar-item relative flex items-center justify-center w-10 h-10 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800 transition-all">
                    <i data-feather="shield" class="w-5 h-5"></i>
                    <span class="sidebar-tooltip">DDI Inspector</span>
                </a>

                <a href="#"
                    class="sidebar-item relative flex items-center justify-center w-10 h-10 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800 transition-all text-opacity-40">
                    <i data-feather="calendar" class="w-5 h-5"></i>
                    <span class="sidebar-tooltip">Schedule (Soon)</span>
                </a>
            </nav>

            <div class="mt-auto flex flex-col space-y-4 px-2 w-full items-center">
                <button onclick="localStorage.clear(); window.location.href='index.html'"
                    class="sidebar-item relative flex items-center justify-center w-10 h-10 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800 transition-all">
                    <i data-feather="log-out" class="w-5 h-5"></i>
                    <span class="sidebar-tooltip">Logout</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col h-full overflow-hidden">
            <!-- PAGE TITLE BAR -->
            <div class="h-16 bg-white border-b border-slate-100 flex items-center justify-between px-8 bg-slate-50/20">
                <h2 class="text-xl font-bold text-slate-800">Electronic Health Records</h2>
            </div>

            <div class="flex-1 flex overflow-hidden">

                <!-- LEFT PANEL: Search & List (35% Width) -->
                <div class="w-[350px] border-r border-slate-200 bg-white flex flex-col shrink-0">
                    <div class="p-6 pb-4">
                        <div class="relative group">
                            <input type="text" id="patient-search" placeholder="Search Name, NIK, or MRN..."
                                class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-indigo-500 transition-all outline-none text-sm">
                            <i data-feather="search"
                                class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto px-4 space-y-2 pb-6" id="patient-list">
                        <div class="py-10 text-center text-slate-400">
                            <i data-feather="user-search" class="w-8 h-8 mx-auto mb-3 opacity-20"></i>
                            <p class="text-xs">Enter a keyword to find patients</p>
                        </div>
                    </div>
                </div>

                <!-- RIGHT PANEL: Full EHR Detail (Flexible) -->
                <div class="flex-1 bg-slate-50 overflow-y-auto" id="ehr-container">
                    <!-- Empty State -->
                    <div class="h-full flex flex-col items-center justify-center text-center p-12 opacity-40">
                        <div class="w-24 h-24 bg-slate-200 rounded-full flex items-center justify-center mb-6">
                            <i data-feather="file-text" class="w-12 h-12 text-slate-400"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-800 mb-2">No Patient Selected</h3>
                        <p class="max-w-md text-slate-500">Select a patient from the list on the left to view their
                            complete
                            medical history, lab results, and upcoming schedule.</p>
                    </div>
                </div>

            </div>
        </main>

        <!-- FHIR EXPORT MODAL -->
        <div id="export-modal"
            class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl w-full max-w-2xl shadow-2xl overflow-hidden animate-fade-up">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <h3 class="text-xl font-bold text-slate-800">HL7 FHIR R4 Export</h3>
                    <button onclick="closeExport()" class="text-slate-400 hover:text-slate-600 transition-colors"><i
                            data-feather="x"></i></button>
                </div>
                <div class="p-8">
                    <p class="text-sm text-slate-500 mb-6 font-medium">This JSON payload complies with International
                        Interoperability Standards (HL7 FHIR). You can share this with clinical partners or research
                        institutions.</p>
                    <div class="bg-slate-900 rounded-2xl p-6 overflow-hidden">
                        <pre class="text-emerald-400 text-xs font-mono max-h-[400px] overflow-y-auto"
                            id="fhir-payload">Generating payload...</pre>
                    </div>
                    <div class="mt-8 flex gap-4">
                        <button onclick="copyFHIR()"
                            class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-all flex items-center justify-center gap-2 shadow-lg shadow-indigo-100">
                            <i data-feather="copy" class="w-4 h-4"></i> Copy JSON
                        </button>
                        <button onclick="downloadFHIR()"
                            class="flex-1 py-3 bg-white border border-slate-200 text-slate-700 font-bold rounded-xl hover:bg-slate-50 transition-all flex items-center justify-center gap-2">
                            <i data-feather="download" class="w-4 h-4"></i> Download .json
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // CONFIG
            const SUPABASE_URL = 'https://crywwqleinnwoacithmw.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyeXd3cWxlaW5ud29hY2l0aG13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MDg4MTIsImV4cCI6MjA4Mzk4NDgxMn0.VTDI6ZQ_aN895A29_v0F1vHzqaS-RG7iGzOFM6qMKfk';
            const supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

            const DOCTOR_NAME = localStorage.getItem('smart_his_name');
            let currentPatient = null;

            document.addEventListener('DOMContentLoaded', () => {
                loadDocProfile();
                startTime();
                initSearch();
                if (window.feather) feather.replace();
            });

            function loadDocProfile() {
                if (DOCTOR_NAME) {
                    document.getElementById('doc-name').textContent = DOCTOR_NAME;
                    document.getElementById('doc-avatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(DOCTOR_NAME)}&background=6366f1&color=fff`;
                }
            }

            function startTime() {
                const timeEl = document.getElementById('live-time');
                const dateEl = document.getElementById('live-date');
                function update() {
                    const now = new Date();
                    timeEl.textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    dateEl.textContent = now.toLocaleDateString('en-US', { weekday: 'long', day: '2-digit', month: 'short' });
                }
                update(); setInterval(update, 1000);
            }

            function initSearch() {
                const input = document.getElementById('patient-search');
                let timer;

                input.addEventListener('input', (e) => {
                    clearTimeout(timer);
                    const query = e.target.value.trim();
                    if (query.length < 2) return;

                    timer = setTimeout(() => searchPatients(query), 400);
                });
            }

            async function searchPatients(q) {
                const list = document.getElementById('patient-list');
                list.innerHTML = `<div class="py-10 text-center"><i data-feather="loader" class="animate-spin w-6 h-6 mx-auto text-indigo-500"></i></div>`;
                feather.replace();

                try {
                    const { data, error } = await supabase.from('patients')
                        .select('*')
                        .or(`full_name.ilike.%${q}%,mrn.ilike.%${q}%,nik.ilike.%${q}%`)
                        .limit(15);

                    if (!data || data.length === 0) {
                        list.innerHTML = `<div class="py-10 text-center text-slate-400 font-medium">No results found for "${q}"</div>`;
                        return;
                    }

                    list.innerHTML = data.map(p => `
                    <div class="patient-card p-4 rounded-2xl border border-slate-100 bg-white cursor-pointer group" onclick="loadPatient('${p.id}')">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-[10px] font-black text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded uppercase tracking-tighter">MRN: ${p.mrn || 'N/A'}</span>
                            <i data-feather="chevron-right" class="w-4 h-4 text-slate-300 group-hover:text-indigo-600 transition-all opacity-0 group-hover:opacity-100"></i>
                        </div>
                        <h4 class="font-bold text-slate-800 truncate">${p.full_name}</h4>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">${p.gender || '--'} â€¢ ${calculateAge(p.dob)} yrs</p>
                    </div>
                `).join('');
                    feather.replace();
                } catch (e) {
                    list.innerHTML = `<p class="text-xs text-red-500 text-center py-10">Search Error</p>`;
                }
            }

            async function loadPatient(id) {
                const container = document.getElementById('ehr-container');
                container.innerHTML = `
                <div class="h-full flex items-center justify-center">
                    <div class="flex flex-col items-center gap-4">
                        <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                        <p class="font-bold text-slate-400 uppercase tracking-widest text-xs">Retrieving Longitudinal EHR...</p>
                    </div>
                </div>
            `;

                try {
                    // Fetch Patient + Lab Results + Appointments + Consultations in parallel
                    const [pRes, labsRes, apptsRes] = await Promise.all([
                        supabase.from('patients').select('*').eq('id', id).single(),
                        supabase.from('lab_results').select('*').eq('patient_id', id).order('created_at', { ascending: false }),
                        supabase.from('appointments').select('*').eq('patient_id', id).order('created_at', { ascending: false })
                    ]);

                    if (pRes.error) throw pRes.error;
                    currentPatient = pRes.data;
                    const labs = labsRes.data || [];
                    const appts = apptsRes.data || [];

                    // Fetch consultations for these appointments
                    let consults = [];
                    if (appts.length > 0) {
                        const { data } = await supabase.from('consultations')
                            .select('*, doctors:profiles!doctor_id(full_name)')
                            .in('appointment_id', appts.map(a => a.id))
                            .order('created_at', { ascending: false });
                        consults = data || [];
                    }

                    renderEHR(currentPatient, labs, appts, consults);
                } catch (e) {
                    container.innerHTML = `<p class="text-sm text-red-500 p-20 text-center font-bold">Failed to load longitudinal data.</p>`;
                }
            }

            function renderEHR(p, labs, appts, consults) {
                const container = document.getElementById('ehr-container');

                container.innerHTML = `
                <div class="p-8 max-w-5xl mx-auto space-y-8 animate-fade-in">
                    
                    <!-- Top Ribbon: Patient Identity -->
                    <div class="flex justify-between items-start">
                        <div class="flex gap-6 items-center">
                            <div class="w-20 h-20 rounded-3xl bg-white border border-slate-200 flex items-center justify-center text-3xl shadow-sm">
                                ${p.gender === 'male' ? 'ðŸ‘¨' : 'ðŸ‘©'}
                            </div>
                            <div>
                                <h2 class="text-3xl font-black text-slate-800">${p.full_name}</h2>
                                <div class="flex items-center gap-3 mt-1">
                                    <span class="text-xs font-bold text-slate-500">DOB: ${new Date(p.dob).toLocaleDateString()}</span>
                                    <span class="w-1 h-1 rounded-full bg-slate-300"></span>
                                    <span class="text-xs font-bold text-slate-500">NIK: ${p.nik || 'N/A'}</span>
                                    <span class="w-1 h-1 rounded-full bg-slate-300"></span>
                                    <span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 rounded">MRN: ${p.mrn}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="openFHIRModal()" class="flex items-center gap-2 px-5 py-2.5 bg-indigo-600 text-white font-bold rounded-xl text-sm shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition-all">
                                <i data-feather="share-2" class="w-4 h-4"></i> Export Interoperability
                            </button>
                        </div>
                    </div>

                    <!-- Clinical Overview Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                            <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-1">Drug Allergies</p>
                            <h4 class="text-sm font-bold ${p.allergies && p.allergies !== 'None' ? 'text-rose-600' : 'text-slate-700'}">
                                ${p.allergies || 'None Recorded'}
                            </h4>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                            <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-1">Insurance / Billing</p>
                            <h4 class="text-sm font-bold text-slate-700">${p.insurance_provider || 'Self Pay'}</h4>
                            <p class="text-[10px] text-slate-400 font-medium mt-1">Status: <span class="text-emerald-500 font-bold uppercase">${p.insurance_status || 'Active'}</span></p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                            <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-1">Next of Kin</p>
                            <h4 class="text-sm font-bold text-slate-700">${p.emergency_name || '--'}</h4>
                            <p class="text-[10px] text-slate-400 font-medium mt-1">${p.emergency_phone || '--'}</p>
                        </div>
                    </div>

                    <!-- Dynamic Tabs -->
                    <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="flex border-b border-slate-100 px-6">
                            <button onclick="switchEHRArea('visits')" id="tab-visits" class="px-6 py-4 text-sm font-bold text-slate-500 tab-active transition-all">Clinical Encounters (${consults.length})</button>
                            <button onclick="switchEHRArea('labs')" id="tab-labs" class="px-6 py-4 text-sm font-bold text-slate-500 transition-all border-b-2 border-transparent">Laboratory Reports (${labs.length})</button>
                            <button onclick="switchEHRArea('schedule')" id="tab-schedule" class="px-6 py-4 text-sm font-bold text-slate-500 transition-all border-b-2 border-transparent">Scheduled Care</button>
                        </div>
                        
                        <div id="ehr-content-area" class="p-6">
                            ${renderVisits(consults)}
                        </div>
                    </div>
                </div>
            `;
                feather.replace();

                // Store local helper functions for the newly injected HTML
                window.switchEHRArea = (type) => {
                    const tabs = ['visits', 'labs', 'schedule'];
                    tabs.forEach(t => {
                        const el = document.getElementById(`tab-${t}`);
                        if (el) {
                            el.classList.remove('tab-active', 'border-indigo-600');
                            el.classList.add('border-transparent');
                        }
                    });
                    document.getElementById(`tab-${type}`).classList.add('tab-active');

                    const area = document.getElementById('ehr-content-area');
                    if (type === 'visits') area.innerHTML = renderVisits(consults);
                    if (type === 'labs') area.innerHTML = renderLabs(labs);
                    if (type === 'schedule') area.innerHTML = renderSchedule(appts);
                    feather.replace();
                };
            }

            function renderVisits(consults) {
                if (consults.length === 0) return `<p class="py-10 text-center text-slate-400 font-medium italic">No past consultations found.</p>`;

                return `
                <div class="space-y-4">
                    ${consults.map(c => `
                        <div class="p-5 border border-slate-100 rounded-2xl hover:bg-slate-50 transition-all border-l-4 border-l-indigo-500">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h4 class="font-bold text-slate-800">${c.assessment || 'General Consultation'}</h4>
                                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-0.5">${new Date(c.created_at).toLocaleDateString()} â€¢ Dr. ${c.doctors?.full_name || 'Medical Staff'}</p>
                                </div>
                                <span class="bg-indigo-50 text-indigo-600 text-[9px] font-black px-2 py-0.5 rounded tracking-tighter uppercase">Clinical Encounter</span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-white/60 p-3 rounded-xl border border-slate-100">
                                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Observation / Findings</p>
                                    <p class="text-xs text-slate-700 leading-relaxed font-medium line-clamp-2">${c.subjective || '--'}</p>
                                </div>
                                <div class="bg-indigo-50/50 p-3 rounded-xl border border-indigo-100">
                                    <p class="text-[9px] font-black text-indigo-600 uppercase tracking-widest mb-1">Clinical Plan</p>
                                    <p class="text-xs text-indigo-900 leading-relaxed font-bold line-clamp-2">${c.plan || '--'}</p>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-slate-100 flex justify-end">
                                <button class="text-[10px] font-black text-indigo-600 uppercase tracking-widest hover:underline flex items-center gap-1">
                                    <i data-feather="external-link" class="w-3 h-3"></i> View Full SOAP Note
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            }

            function renderLabs(labs) {
                if (labs.length === 0) return `<p class="py-10 text-center text-slate-400 font-medium italic">No laboratory results found.</p>`;

                return `
                <div class="border border-slate-100 rounded-2xl overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr>
                                <th class="px-4 py-3 font-bold text-slate-500 uppercase tracking-widest text-[9px]">Test Description</th>
                                <th class="px-4 py-3 font-bold text-slate-500 uppercase tracking-widest text-[9px]">Result Value</th>
                                <th class="px-4 py-3 font-bold text-slate-500 uppercase tracking-widest text-[9px]">Standard (LOINC)</th>
                                <th class="px-4 py-3 font-bold text-slate-500 uppercase tracking-widest text-[9px]">Recorded At</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            ${labs.map(l => `
                                <tr class="hover:bg-slate-50 transition-colors">
                                    <td class="px-4 py-3">
                                        <p class="font-bold text-slate-800">${l.test_name}</p>
                                        <p class="text-[10px] text-slate-400 uppercase font-bold">${l.test_category}</p>
                                    </td>
                                    <td class="px-4 py-3 font-black text-indigo-600">${l.result_value}</td>
                                    <td class="px-4 py-3 font-mono text-xs text-slate-500">${l.loinc_code || '--'}</td>
                                    <td class="px-4 py-3 text-xs text-slate-500">${new Date(l.created_at).toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            }

            function renderSchedule(appts) {
                const upcoming = appts.filter(a => a.status !== 'completed' && a.status !== 'cancelled');
                if (upcoming.length === 0) return `<p class="py-10 text-center text-slate-400 font-medium italic">No upcoming appointments scheduled.</p>`;

                return `
                <div class="space-y-3">
                    ${upcoming.map(a => `
                        <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                            <div class="w-12 h-12 bg-white rounded-xl shadow-sm flex flex-col items-center justify-center border border-slate-200">
                                <span class="text-[8px] font-black text-rose-500 uppercase">${new Date(a.scheduled_time || a.created_at).toLocaleString('en-US', { month: 'short' })}</span>
                                <span class="text-xl font-black text-slate-800">${new Date(a.scheduled_time || a.created_at).getDate()}</span>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-bold text-slate-800">${a.status.replace('_', ' ').toUpperCase()} SESSION</p>
                                <p class="text-xs text-slate-400 font-medium">${new Date(a.scheduled_time || a.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} â€¢ Standard Consultation Slot</p>
                            </div>
                            <span class="px-3 py-1 bg-white border border-slate-200 rounded-full text-[9px] font-black text-slate-500 uppercase tracking-widest">${a.status}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            }

            // FHIR LOGIC
            function openFHIRModal() {
                if (!currentPatient) return;
                const modal = document.getElementById('export-modal');
                const pre = document.getElementById('fhir-payload');

                const fhir = {
                    resourceType: "Bundle",
                    type: "collection",
                    entry: [
                        {
                            resource: {
                                resourceType: "Patient",
                                id: currentPatient.id,
                                identifier: [{ system: "NIK", value: currentPatient.nik }, { system: "MRN", value: currentPatient.mrn }],
                                name: [{ use: "official", text: currentPatient.full_name }],
                                gender: currentPatient.gender,
                                birthDate: currentPatient.dob,
                                telecom: [{ system: "phone", value: currentPatient.phone_number }],
                                address: [{ text: currentPatient.address }]
                            }
                        }
                    ]
                };

                pre.textContent = JSON.stringify(fhir, null, 4);
                modal.classList.remove('hidden');
                feather.replace();
            }

            function closeExport() { document.getElementById('export-modal').classList.add('hidden'); }
            function copyFHIR() {
                navigator.clipboard.writeText(document.getElementById('fhir-payload').textContent);
                alert("FHIR JSON copied to clipboard!");
            }
            function downloadFHIR() {
                const data = document.getElementById('fhir-payload').textContent;
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `patient_${currentPatient.mrn}_fhir.json`;
                a.click();
            }

            function calculateAge(dob) {
                if (!dob) return '--';
                return Math.floor((new Date() - new Date(dob)) / 31557600000);
            }
        </script>
</body>

</html>
