<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Registration - Smart HIS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        h1,
        h2,
        h3,
        .brand-font {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .form-section {
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 24px;
            margin-bottom: 24px;
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
    </style>
</head>

<body class="min-h-screen py-10 px-6">

    <div class="max-w-4xl mx-auto">
        <!-- Back Button -->
        <a href="ADMIN_PORTAL.html"
            class="inline-flex items-center gap-2 text-gray-500 hover:text-indigo-600 transition-colors mb-6 font-medium">
            <i data-feather="arrow-left" class="w-4 h-4"></i>
            Back to Dashboard
        </a>

        <div class="bg-white rounded-3xl shadow-xl shadow-slate-200/50 overflow-hidden border border-slate-100">
            <!-- Header -->
            <div class="px-10 py-8 bg-indigo-600 text-white flex items-center gap-6">
                <div class="p-4 bg-white/20 rounded-2xl backdrop-blur-md">
                    <i data-feather="user-plus" class="w-8 h-8 text-white"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold brand-font">Patient Registration</h1>
                    <p class="text-indigo-100 mt-1">Register a new patient account with complete clinical and insurance
                        data.</p>
                </div>
            </div>

            <form id="register-form" class="p-10">

                <!-- 1. ACCOUNT ACCESS -->
                <div class="form-section">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                        <i data-feather="lock" class="w-4 h-4"></i> Account Access
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Login Email Address</label>
                            <input type="email" id="reg-email" required
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all bg-slate-50/50"
                                placeholder="patient@example.com">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Temporary Password</label>
                            <input type="text" id="reg-pass" value="password123"
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl text-gray-500 transition-all bg-slate-50/50">
                        </div>
                    </div>
                </div>

                <!-- 2. PERSONAL INFORMATION -->
                <div class="form-section">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                        <i data-feather="user" class="w-4 h-4"></i> Personal Information
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Patient Full Name
                                (Legal)</label>
                            <input type="text" id="reg-name" required
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 transition-all bg-slate-50/50"
                                placeholder="Enter full name as per identity card">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">National ID (NIK)</label>
                            <input type="text" id="reg-nik" required
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 transition-all bg-slate-50/50"
                                placeholder="16-digit ID number">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Date of Birth</label>
                                <input type="date" id="reg-dob" required
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 transition-all bg-slate-50/50">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Gender</label>
                                <select id="reg-gender"
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 transition-all bg-slate-50/50">
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Phone Number</label>
                            <input type="tel" id="reg-phone"
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 transition-all bg-slate-50/50"
                                placeholder="+62 812-3456-7890">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Residential Address</label>
                            <input type="text" id="reg-address"
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 transition-all bg-slate-50/50"
                                placeholder="Full home address">
                        </div>
                    </div>
                </div>

                <!-- 3. CLINICAL DATA -->
                <div class="form-section">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                        <i data-feather="activity" class="w-4 h-4"></i> Clinical Data
                    </h3>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Known Allergies</label>
                        <textarea id="reg-allergies" rows="2"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 transition-all bg-slate-50/50"
                            placeholder="List drug, food, or environmental allergies (if none, type 'None')"></textarea>
                    </div>
                </div>

                <!-- 4. INSURANCE INFORMATION -->
                <div class="form-section">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                        <i data-feather="shield" class="w-4 h-4"></i> Insurance & Billing
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Insurance Provider</label>
                            <input type="text" id="reg-ins-provider"
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 transition-all bg-slate-50/50"
                                placeholder="e.g. BPJS, Prudential, Allianz">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Insurance Number / ID</label>
                            <input type="text" id="reg-ins-id"
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 transition-all bg-slate-50/50"
                                placeholder="Policy or member ID">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Coverage Limit
                                (Optional)</label>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">$</span>
                                <input type="number" id="reg-ins-limit"
                                    class="w-full pl-8 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 transition-all bg-slate-50/50"
                                    placeholder="0.00">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Plan Type</label>
                            <input type="text" id="reg-ins-plan"
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 transition-all bg-slate-50/50"
                                placeholder="e.g. Elite Platinum, Class 1">
                        </div>
                    </div>
                </div>

                <div id="msg-box" class="hidden p-4 rounded-xl text-center mb-8 font-bold border animate-pulse"></div>

                <button type="submit"
                    class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-100 flex items-center justify-center gap-2 text-lg">
                    <i data-feather="check-circle" class="w-5 h-5"></i> Complete Registration
                </button>
            </form>
        </div>

        <div class="mt-8 text-center text-gray-400 text-sm">
            &copy; 2025 Smart Health Information Systems. Confidentiality maintained via standard HIS protocols.
        </div>
    </div>

    <script>
        feather.replace();

        // 1. Init Supabase
        const SUPABASE_URL = 'https://crywwqleinnwoacithmw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyeXd3cWxlaW5ud29hY2l0aG13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MDg4MTIsImV4cCI6MjA4Mzk4NDgxMn0.VTDI6ZQ_aN895A29_v0F1vHzqaS-RG7iGzOFM6qMKfk';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const form = document.getElementById('register-form');
        const msgBox = document.getElementById('msg-box');

        // Security Check
        const userToken = localStorage.getItem('smart_his_token');
        const userRole = localStorage.getItem('smart_his_role');
        if (!userToken || userRole !== 'admin') {
            window.location.href = 'index.html';
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = form.querySelector('button');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i data-feather="loader" class="animate-spin w-5 h-5"></i> Processing...';
            feather.replace();
            msgBox.classList.add('hidden');

            const payload = {
                email: document.getElementById('reg-email').value,
                password: document.getElementById('reg-pass').value,
                name: document.getElementById('reg-name').value,
                dob: document.getElementById('reg-dob').value,
                gender: document.getElementById('reg-gender').value,
                nik: document.getElementById('reg-nik').value,
                phone_number: document.getElementById('reg-phone').value,
                address: document.getElementById('reg-address').value,
                allergies: document.getElementById('reg-allergies').value,
                insurance_provider: document.getElementById('reg-ins-provider').value,
                insurance_number: document.getElementById('reg-ins-id').value,
                insurance_coverage_limit: document.getElementById('reg-ins-limit').value ? parseFloat(document.getElementById('reg-ins-limit').value) : null,
                insurance_plan_type: document.getElementById('reg-ins-plan').value
            };

            try {
                const { data, error } = await supabase.functions.invoke('create-patient', {
                    body: payload,
                    headers: {
                        Authorization: `Bearer ${userToken}`
                    }
                });

                if (error) throw error;

                showMessage("success", "Registration Complete! Patient created and MRN assigned.");
                form.reset();
                document.getElementById('reg-pass').value = "password123";
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (err) {
                console.error(err);
                showMessage("error", err.message || "Failed to register patient.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
                feather.replace();
            }
        });

        function showMessage(type, text) {
            msgBox.innerText = text;
            msgBox.classList.remove('hidden', 'bg-emerald-50', 'text-emerald-700', 'border-emerald-200', 'bg-red-50', 'text-red-700', 'border-red-200');
            if (type === 'success') {
                msgBox.classList.add('bg-emerald-50', 'text-emerald-700', 'border-emerald-200', 'block');
            } else {
                msgBox.classList.add('bg-red-50', 'text-red-700', 'border-red-200', 'block');
            }
        }
    </script>
</body>

</html>
